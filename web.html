<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Banco - Tombola Romana</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', serif;
            background: linear-gradient(135deg, #8B4513 0%, #D2691E 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: #FFF8DC;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        h1 {
            text-align: center;
            color: #8B0000;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .subtitle {
            text-align: center;
            color: #654321;
            font-size: 1.2em;
            margin-bottom: 30px;
            font-style: italic;
        }

        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 30px;
        }

        button {
            background: linear-gradient(135deg, #8B0000 0%, #DC143C 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.1em;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        button:disabled {
            background: #999;
            cursor: not-allowed;
            transform: none;
        }

        .extraction-area {
            background: white;
            border: 4px solid #8B0000;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
        }

        .current-extraction {
            font-size: 4em;
            margin: 20px 0;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #FFF8DC;
            border-radius: 10px;
            padding: 20px;
        }

        .extraction-history {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
            max-height: 150px;
            overflow-y: auto;
        }

        .history-item {
            background: #F0E68C;
            padding: 8px 15px;
            border-radius: 8px;
            font-size: 1.2em;
            border: 2px solid #DAA520;
        }

        /* Giocatori */
        .giocatori-section {
            background: white;
            border: 4px solid #228B22;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .giocatori-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .form-giocatore {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        input[type="text"], input[type="number"], select {
            padding: 10px;
            font-size: 1em;
            border: 2px solid #D2691E;
            border-radius: 8px;
            font-family: 'Georgia', serif;
        }

        .lista-giocatori {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .giocatore-card {
            background: #FFF8DC;
            border: 3px solid #D2691E;
            border-radius: 10px;
            padding: 15px;
            position: relative;
        }

        .giocatore-nome {
            font-weight: bold;
            color: #8B0000;
            font-size: 1.1em;
            margin-bottom: 5px;
        }

        .giocatore-cartella {
            color: #654321;
            font-size: 0.9em;
        }

        .btn-remove {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #DC143C;
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            font-size: 0.8em;
        }

        /* Tabellone */
        .tabellone {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 8px;
            margin-bottom: 30px;
            background: white;
            padding: 20px;
            border-radius: 15px;
            border: 4px solid #8B0000;
        }

        .simbolo {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #FFF8DC;
            border: 2px solid #D2691E;
            border-radius: 10px;
            padding: 5px;
            font-size: 0.75em;
            text-align: center;
            transition: all 0.3s;
        }

        .simbolo.estratto {
            background: #90EE90;
            border-color: #006400;
            transform: scale(0.95);
        }

        .simbolo-numero {
            font-size: 0.85em;
            font-weight: bold;
            color: #8B0000;
            margin-bottom: 3px;
        }

        .simbolo-icona {
            font-size: 2.2em;
            margin-bottom: 3px;
        }

        .simbolo-nome {
            font-size: 0.8em;
            font-weight: bold;
            color: #654321;
            line-height: 1.1;
        }

        /* Cartelle in Gioco */
        .cartelle-gioco {
            background: white;
            border: 4px solid #8B0000;
            border-radius: 15px;
            padding: 20px;
        }

        .cartelle-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .cartella {
            background: #FFF8DC;
            border: 3px solid #D2691E;
            border-radius: 12px;
            padding: 15px;
        }

        .cartella-header {
            text-align: center;
            font-weight: bold;
            font-size: 1.1em;
            color: #8B0000;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 2px solid #D2691E;
        }

        .cartella-grid-cella {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 5px;
        }

        .cartella-cella {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: white;
            border: 2px solid #D2691E;
            border-radius: 8px;
            padding: 5px;
            font-size: 0.7em;
            text-align: center;
        }

        .cartella-cella.segnato {
            background: #FFD700;
            border-color: #FF8C00;
        }

        .cartella-cella-icona {
            font-size: 1.8em;
            margin-bottom: 2px;
        }

        .cartella-cella-nome {
            font-size: 0.65em;
            font-weight: bold;
            color: #654321;
            line-height: 1;
        }

        .stats {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 10px;
        }

        .stat-item {
            text-align: center;
            padding: 10px 20px;
            background: #FFF8DC;
            border-radius: 8px;
            border: 2px solid #D2691E;
        }

        .stat-label {
            font-size: 0.9em;
            color: #654321;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #8B0000;
        }

        .vittoria-alert {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border: 5px solid #FFD700;
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            font-size: 2em;
            color: #8B0000;
            font-weight: bold;
            box-shadow: 0 10px 50px rgba(0,0,0,0.5);
            z-index: 1000;
            animation: vittoria-pulse 0.5s ease-in-out;
            min-width: 400px;
            max-width: 700px;
        }

        .vittoria-alert button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
        }

        @keyframes vittoria-pulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
        }

        @media (max-width: 768px) {
            .tabellone {
                grid-template-columns: repeat(5, 1fr);
                gap: 5px;
                padding: 10px;
            }

            .simbolo {
                font-size: 0.6em;
            }

            .cartelle-grid {
                grid-template-columns: 1fr;
            }

            h1 {
                font-size: 1.8em;
            }

            .vittoria-alert {
                font-size: 1.5em;
                min-width: auto;
                width: 90%;
                padding: 30px 20px;
            }
        }
        /* POPUP CURIOSIT√Ä TREBULA */
        .popup-curiosita {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            animation: fadeIn 0.3s;
        }
        .popup-curiosita-content {
            background: linear-gradient(135deg, #FFF8DC 0%, #FAEBD7 100%);
            margin: 5% auto;
            padding: 0;
            width: 90%;
            max-width: 700px;
            border-radius: 20px;
            box-shadow: 0 15px 60px rgba(0,0,0,0.6);
            animation: zoomIn 0.4s;
            border: 5px solid #8B4513;
        }
        .popup-curiosita-header {
            background: linear-gradient(135deg, #8B4513 0%, #D2691E 100%);
            color: white;
            padding: 25px 30px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .popup-curiosita-header h2 {
            margin: 0;
            font-size: 1.8em;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .popup-curiosita-emoji {
            font-size: 2.5em;
        }
        .close-curiosita {
            color: white;
            font-size: 3em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            line-height: 1;
        }
        .close-curiosita:hover {
            transform: scale(1.2) rotate(90deg);
            color: #FFD700;
        }
        .popup-curiosita-body {
            padding: 35px;
            color: #654321;
            line-height: 1.8;
            font-size: 1.1em;
        }
        .popup-curiosita-simbolo {
            text-align: center;
            padding: 20px;
            background: white;
            border-radius: 15px;
            margin-bottom: 25px;
            border: 3px solid #D2691E;
        }
        .popup-curiosita-simbolo-grande {
            font-size: 4em;
            margin-bottom: 10px;
        }
        .popup-curiosita-simbolo-info {
            font-size: 1.3em;
            font-weight: bold;
            color: #8B0000;
        }
        .popup-curiosita-testo {
            text-align: justify;
            font-size: 1.05em;
            line-height: 1.7;
        }
        .popup-curiosita-footer {
            text-align: center;
            padding: 20px;
            border-top: 2px solid #D2691E;
        }
        .btn-continua {
            background: linear-gradient(135deg, #228B22 0%, #32CD32 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.2em;
            font-weight: bold;
            border-radius: 30px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            transition: all 0.3s;
        }
        .btn-continua:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
        }
        @keyframes zoomIn {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
    </style>
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body>
    <div class="container">
        <h1>üèõÔ∏è TOMBOLA ROMANA - BANCO üèõÔ∏è</h1>
        <div class="subtitle">Gestione Completa del Gioco</div>

        <!-- TOGGLE MODALIT√Ä -->
        <div style="display: flex; gap: 10px; justify-content: center; margin-bottom: 20px; background: white; padding: 15px; border-radius: 10px;">
            <button id="btnModeLocal" class="mode-btn active" onclick="switchMode('local')" style="flex: 1; padding: 15px; font-size: 1.1em; font-weight: bold; border: 3px solid #228B22; background: linear-gradient(135deg, #228B22 0%, #32CD32 100%); color: white; border-radius: 10px; cursor: pointer;">
                üíª Modalit√† Locale
            </button>
            <button id="btnModeOnline" class="mode-btn" onclick="switchMode('online')" style="flex: 1; padding: 15px; font-size: 1.1em; font-weight: bold; border: 3px solid #ddd; background: #f5f5f5; color: #666; border-radius: 10px; cursor: pointer;">
                üåê Modalit√† Online
            </button>
        </div>

        <!-- PANNELLO ONLINE (nascosto di default) -->
        <div id="onlinePanel" style="display: none; background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
            <h2 style="color: #4A90E2; text-align: center; margin-bottom: 15px;">üåê Modalit√† Online</h2>
            
            <!-- PRIMA DI CREARE -->
            <div id="onlinePre" style="text-align: center;">
                <p style="color: #666; margin-bottom: 15px;">Crea una stanza per giocare online con amici!</p>
                <button onclick="createRoom()" style="padding: 15px 30px; font-size: 1.2em; background: linear-gradient(135deg, #4A90E2 0%, #357ABD 100%); color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer;">
                    üéÆ Crea Stanza
                </button>
            </div>
            
            <!-- DOPO CREAZIONE -->
            <div id="onlinePost" style="display: none; text-align: center;">
                <h3 style="color: #228B22; margin-bottom: 10px;">‚úÖ Stanza Creata!</h3>
                <div style="background: #FFF8DC; border: 3px solid #4A90E2; border-radius: 15px; padding: 20px; margin: 15px 0;">
                    <p style="color: #654321; margin-bottom: 5px; font-weight: bold;">Codice Stanza:</p>
                    <p id="displayRoomCode" style="font-size: 2.5em; font-weight: bold; color: #8B0000; letter-spacing: 5px; margin: 10px 0;">------</p>
                    <p style="color: #666; font-size: 0.9em;">Condividi questo codice con i giocatori!</p>
                </div>
                <p id="playersOnlineCount" style="color: #4A90E2; font-weight: bold; margin-top: 15px;">üë• Giocatori connessi: 0</p>
            </div>
        </div>

        <!-- REGISTRAZIONE GIOCATORI -->
        <div class="giocatori-section" id="localPanel">
            <div class="giocatori-header">
                <h2 style="color: #228B22;">üë• Registrazione Giocatori</h2>
                <div style="margin-top: 15px; padding: 15px; background: #FFF8DC; border-radius: 10px; border: 2px solid #D2691E;">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; font-size: 1.1em;">
                        <input type="checkbox" id="toggleCuriosita" style="width: 20px; height: 20px; cursor: pointer;">
                        <span style="font-weight: bold; color: #8B4513;">
                            üèõÔ∏è Attiva Curiosit√† su Trebula Mutuesca
                        </span>
                    </label>
                    <p style="margin: 10px 0 0 30px; font-size: 0.9em; color: #654321; font-style: italic;">
                        Durante il gioco appariranno curiosit√† storiche su alcuni simboli estratti
                    </p>
                </div>
            </div>
            
            <div class="form-giocatore">
                <input type="text" id="nomeGiocatore" placeholder="Nome giocatore" style="flex: 1; min-width: 200px;">
                <select id="numeroCartella" style="width: 150px;">
                    <option value="">Cartella...</option>
                </select>
                <button onclick="aggiungiGiocatore()" style="background: linear-gradient(135deg, #228B22 0%, #32CD32 100%);">
                    ‚úÖ Aggiungi
                </button>
            </div>

            <div class="lista-giocatori" id="listaGiocatori">
                <div style="grid-column: 1/-1; text-align: center; color: #999; padding: 20px;">
                    Nessun giocatore registrato. Aggiungi i giocatori prima di iniziare.
                </div>
            </div>
        </div>

        <!-- CONTROLLI GIOCO -->
        <div style="text-align: center; margin-bottom: 15px; padding: 10px; background: white; border-radius: 10px;">
            <span style="color: #654321;">Progettato da <strong style="color: #8B0000;">Ciro Torelli</strong></span>
        </div>

        <div class="controls">
            <button onclick="iniziaGioco()">üé≤ Inizia Partita</button>
            <button onclick="estraiSimbolo()" id="btnEstrai" disabled>üéØ Estrai Simbolo</button>
            <button onclick="resetGioco()">üîÑ Reset Gioco</button>
            <a href="index.html" style="text-decoration: none;">
                <button style="background: linear-gradient(135deg, #666 0%, #999 100%);">
                    üè† Torna al Menu
                </button>
            </a>
        </div>

        <!-- STATISTICHE -->
        <div class="stats">
            <div class="stat-item">
                <div class="stat-label">Giocatori</div>
                <div class="stat-value" id="numGiocatori">0</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Simboli Estratti</div>
                <div class="stat-value" id="numEstratti">0/90</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Simboli Rimasti</div>
                <div class="stat-value" id="numRimasti">90</div>
            </div>
        </div>

        <!-- ESTRAZIONE -->
        <div class="extraction-area">
            <h2 style="color: #8B0000; margin-bottom: 15px;">Ultimo Simbolo Estratto</h2>
            <div class="current-extraction" id="currentExtraction">
                Registra i giocatori e premi "Inizia Partita"
            </div>
            <div class="extraction-history" id="extractionHistory"></div>
        </div>

        <!-- TABELLONE -->
        <h2 style="color: #8B0000; margin-bottom: 15px; text-align: center;">Tabellone Completo</h2>
        <div class="tabellone" id="tabellone"></div>

        <!-- CARTELLE IN GIOCO -->
        <div class="cartelle-gioco">
            <h2 style="color: #8B0000; text-align: center;">Cartelle in Gioco</h2>
            <div class="cartelle-grid" id="cartelleGrid">
                <div style="grid-column: 1/-1; text-align: center; color: #999; padding: 40px;">
                    Nessuna cartella in gioco. Registra i giocatori e inizia la partita.
                </div>
            </div>
        </div>
    </div>

    <script>
        // SISTEMA CURIOSIT√Ä TREBULA
        let curiositaAttive = false;
        let curiositaData = null;
        async function caricaCuriosita() {
            try {
                const response = await fetch('curiosita-trebula.json');
                if (response.ok) {
                    curiositaData = await response.json();
                    console.log('‚úÖ Curiosit√† Trebula caricate:', curiositaData.curiosita.length);
                }
            } catch (error) {
                console.log('‚ÑπÔ∏è File curiosita-trebula.json non trovato');
            }
        }
        caricaCuriosita();
        function mostraCuriosita(simboloIndex) {
            if (!curiositaAttive || !curiositaData) return;
            const curiosita = curiositaData.curiosita.find(c => c.simboloIndex === simboloIndex);
            if (curiosita) {
                document.getElementById('curiositaEmoji').textContent = curiosita.immagine;
                document.getElementById('curiositaTitolo').textContent = curiosita.titolo;
                document.getElementById('curiositaSimbolo').textContent = curiosita.immagine;
                document.getElementById('curiositaNumero').textContent = curiosita.numero;
                document.getElementById('curiositaNome').textContent = curiosita.simbolo;
                document.getElementById('curiositaTesto').textContent = curiosita.testo;
                document.getElementById('popupCuriosita').style.display = 'block';
                document.body.style.overflow = 'hidden';
            }
        }
        function chiudiCuriosita() {
            document.getElementById('popupCuriosita').style.display = 'none';
            document.body.style.overflow = '';
        }
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                chiudiCuriosita();
            }
        });

        // SISTEMA AUDIO
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();

        // Suono estrazione (ding melodioso)
        function suonoEstrazione() {
            const now = audioCtx.currentTime;
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            
            oscillator.frequency.setValueAtTime(659.25, now);
            oscillator.frequency.setValueAtTime(783.99, now + 0.1);
            oscillator.frequency.setValueAtTime(1046.50, now + 0.2);
            
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.3, now);
            gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.4);
            
            oscillator.start(now);
            oscillator.stop(now + 0.4);
        }

        // Suono vittoria (campana/fanfara)
        function suonoVittoria(tipo) {
            const now = audioCtx.currentTime;
            const note = tipo === 'tombola' 
                ? [523.25, 659.25, 783.99, 1046.50, 783.99, 1046.50, 1318.51]
                : [523.25, 659.25, 783.99];
            
            note.forEach((freq, index) => {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                
                osc.frequency.value = freq;
                osc.type = 'triangle';
                
                const startTime = now + (index * 0.2);
                const stopTime = startTime + 0.3;
                
                gain.gain.setValueAtTime(0.4, startTime);
                gain.gain.exponentialRampToValueAtTime(0.01, stopTime);
                
                osc.start(startTime);
                osc.stop(stopTime);
            });
            
            if (tipo === 'tombola') {
                setTimeout(() => {
                    note.forEach((freq, index) => {
                        const osc = audioCtx.createOscillator();
                        const gain = audioCtx.createGain();
                        
                        osc.connect(gain);
                        gain.connect(audioCtx.destination);
                        
                        osc.frequency.value = freq * 1.5;
                        osc.type = 'sine';
                        
                        const startTime = audioCtx.currentTime + (index * 0.15);
                        const stopTime = startTime + 0.25;
                        
                        gain.gain.setValueAtTime(0.2, startTime);
                        gain.gain.exponentialRampToValueAtTime(0.01, stopTime);
                        
                        osc.start(startTime);
                        osc.stop(stopTime);
                    });
                }, 300);
            }
        }

        // Inizializza audio al primo click
        document.addEventListener('click', function initAudio() {
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }, { once: true });

        // Dati incorporati
        const DATI_CARTELLE = {"simboli": [{"icona": "‚ö°", "nome": "Giove"}, {"icona": "‚öîÔ∏è", "nome": "Marte"}, {"icona": "üíï", "nome": "Venere"}, {"icona": "ü¶â", "nome": "Minerva"}, {"icona": "üåä", "nome": "Nettuno"}, {"icona": "üèπ", "nome": "Diana"}, {"icona": "‚òÄÔ∏è", "nome": "Apollo"}, {"icona": "ü™Ω", "nome": "Mercurio"}, {"icona": "üëë", "nome": "Giunone"}, {"icona": "üî•", "nome": "Vulcano"}, {"icona": "üèõÔ∏è", "nome": "Foro"}, {"icona": "‚ô®Ô∏è", "nome": "Terme"}, {"icona": "üèüÔ∏è", "nome": "Anfiteatro"}, {"icona": "üèá", "nome": "Circo"}, {"icona": "üõï", "nome": "Tempio"}, {"icona": "üè¢", "nome": "Basilica"}, {"icona": "üé≠", "nome": "Teatro"}, {"icona": "üåâ", "nome": "Acquedotto"}, {"icona": "üè∞", "nome": "Arco"}, {"icona": "üìö", "nome": "Biblioteca"}, {"icona": "üèõÔ∏è", "nome": "Curia"}, {"icona": "üè™", "nome": "Mercato"}, {"icona": "üè†", "nome": "Domus"}, {"icona": "üè°", "nome": "Villa"}, {"icona": "üèòÔ∏è", "nome": "Insula"}, {"icona": "üö™", "nome": "Atrio"}, {"icona": "üåø", "nome": "Peristilio"}, {"icona": "üõãÔ∏è", "nome": "Triclinio"}, {"icona": "üç≥", "nome": "Cucina"}, {"icona": "üïØÔ∏è", "nome": "Larario"}, {"icona": "üë®‚Äçü¶±", "nome": "Imperatore"}, {"icona": "üéñÔ∏è", "nome": "Console"}, {"icona": "üìú", "nome": "Senatore"}, {"icona": "üõ°Ô∏è", "nome": "Centurione"}, {"icona": "‚öîÔ∏è", "nome": "Legionario"}, {"icona": "üó°Ô∏è", "nome": "Gladiatore"}, {"icona": "üë∞", "nome": "Vestale"}, {"icona": "‚úçÔ∏è", "nome": "Scriba"}, {"icona": "üí∞", "nome": "Mercante"}, {"icona": "üî®", "nome": "Artigiano"}, {"icona": "üëò", "nome": "Toga"}, {"icona": "üëî", "nome": "Tunica"}, {"icona": "üëó", "nome": "Stola"}, {"icona": "üß£", "nome": "Palla"}, {"icona": "üë°", "nome": "Sandali"}, {"icona": "üëû", "nome": "Calcei"}, {"icona": "üìç", "nome": "Fibula"}, {"icona": "üåø", "nome": "Corona"}, {"icona": "üè∫", "nome": "Anfora"}, {"icona": "ü™î", "nome": "Lucerna"}, {"icona": "üñäÔ∏è", "nome": "Stilo"}, {"icona": "üìù", "nome": "Tavoletta"}, {"icona": "üìú", "nome": "Rotolo"}, {"icona": "ü™ô", "nome": "Moneta"}, {"icona": "üîë", "nome": "Chiave"}, {"icona": "ü™û", "nome": "Specchio"}, {"icona": "üíà", "nome": "Pettine"}, {"icona": "üé≤", "nome": "Dado"}, {"icona": "ü¶¥", "nome": "Astragalo"}, {"icona": "üíç", "nome": "Sigillo"}, {"icona": "üó°Ô∏è", "nome": "Gladio"}, {"icona": "üõ°Ô∏è", "nome": "Scudo"}, {"icona": "üî±", "nome": "Lancia"}, {"icona": "‚õëÔ∏è", "nome": "Elmo"}, {"icona": "ü¶∫", "nome": "Corazza"}, {"icona": "ü¶Ö", "nome": "Aquila"}, {"icona": "üö©", "nome": "Vessillo"}, {"icona": "üèπ", "nome": "Catapulta"}, {"icona": "üçû", "nome": "Pane"}, {"icona": "üç∑", "nome": "Vino"}, {"icona": "ü´í", "nome": "Olive"}, {"icona": "üêü", "nome": "Garum"}, {"icona": "üçé", "nome": "Frutta"}, {"icona": "üßÄ", "nome": "Formaggio"}, {"icona": "üçØ", "nome": "Miele"}, {"icona": "üêó", "nome": "Cinghiale"}, {"icona": "üê†", "nome": "Pesce"}, {"icona": "üçá", "nome": "Uva"}, {"icona": "üöú", "nome": "Aratro"}, {"icona": "üî™", "nome": "Falce"}, {"icona": "üî®", "nome": "Martello"}, {"icona": "‚öíÔ∏è", "nome": "Incudine"}, {"icona": "üìê", "nome": "Compasso"}, {"icona": "üìè", "nome": "Livella"}, {"icona": "üé°", "nome": "Ruota"}, {"icona": "ü¶Ö", "nome": "Aquila"}, {"icona": "üê∫", "nome": "Lupo"}, {"icona": "üê¥", "nome": "Cavallo"}, {"icona": "üêï", "nome": "Cane"}, {"icona": "üê¨", "nome": "Delfino"}], "cartelle": [[64, 81, 3, 32, 34, 59, 86, 38, 41, 29, 79, 65, 4, 11, 69], [28, 52, 34, 3, 89, 43, 66, 68, 57, 84, 19, 31, 49, 65, 20], [2, 80, 42, 3, 35, 6, 62, 64, 50, 87, 82, 20, 53, 56, 38], [84, 25, 77, 3, 23, 89, 37, 79, 67, 58, 42, 11, 50, 34, 56], [65, 32, 71, 70, 42, 85, 63, 61, 58, 88, 53, 20, 13, 31, 12], [76, 51, 2, 82, 27, 61, 1, 67, 33, 78, 80, 15, 53, 87, 23], [34, 2, 15, 59, 26, 54, 63, 11, 36, 84, 14, 81, 56, 80, 38], [25, 24, 38, 81, 73, 2, 51, 18, 58, 87, 50, 19, 4, 44, 65], [6, 60, 16, 65, 73, 34, 66, 85, 27, 2, 52, 79, 47, 75, 38], [43, 1, 50, 71, 67, 26, 49, 64, 32, 6, 10, 77, 3, 12, 74], [48, 9, 37, 54, 83, 38, 2, 29, 10, 20, 77, 19, 44, 47, 85], [33, 3, 40, 75, 86, 71, 82, 17, 22, 32, 66, 14, 23, 15, 27], [8, 74, 85, 32, 68, 12, 70, 59, 60, 11, 86, 62, 28, 48, 31], [65, 5, 20, 47, 82, 60, 48, 7, 49, 86, 32, 89, 61, 53, 6], [13, 88, 31, 43, 72, 71, 14, 54, 9, 80, 47, 53, 39, 73, 65], [33, 20, 79, 55, 77, 35, 89, 23, 24, 76, 59, 1, 15, 53, 65], [32, 79, 58, 13, 67, 20, 10, 55, 6, 60, 8, 18, 23, 43, 46], [83, 0, 85, 12, 80, 10, 26, 87, 30, 11, 27, 16, 51, 4, 68], [53, 60, 43, 40, 3, 52, 6, 63, 86, 21, 25, 24, 12, 4, 54], [28, 0, 74, 14, 11, 21, 12, 77, 63, 42, 73, 41, 6, 48, 87], [85, 48, 37, 66, 38, 75, 21, 16, 70, 39, 56, 0, 14, 29, 59], [76, 34, 22, 49, 41, 64, 67, 79, 69, 1, 48, 65, 5, 58, 6], [41, 59, 85, 88, 57, 32, 43, 6, 11, 30, 14, 24, 36, 75, 69], [58, 25, 48, 19, 47, 17, 76, 64, 79, 36, 18, 61, 34, 41, 14], [37, 59, 21, 17, 83, 12, 39, 45, 19, 18, 16, 1, 42, 60, 31], [54, 21, 65, 29, 85, 15, 2, 70, 75, 52, 16, 6, 9, 22, 58], [58, 65, 86, 7, 37, 72, 52, 75, 35, 54, 67, 23, 59, 27, 66], [11, 83, 51, 31, 86, 29, 2, 49, 41, 82, 61, 9, 23, 45, 19], [16, 17, 51, 32, 26, 24, 74, 61, 66, 58, 73, 56, 57, 15, 43], [54, 19, 47, 37, 5, 80, 7, 43, 34, 33, 2, 11, 26, 32, 63], [68, 12, 55, 60, 3, 34, 1, 35, 76, 19, 59, 75, 46, 88, 50], [48, 39, 77, 66, 79, 7, 61, 87, 47, 1, 59, 41, 26, 78, 51], [35, 24, 37, 55, 41, 40, 89, 73, 85, 60, 57, 49, 87, 76, 46], [47, 36, 57, 11, 60, 29, 52, 9, 5, 67, 76, 8, 22, 42, 38], [51, 42, 77, 69, 7, 44, 74, 21, 43, 37, 40, 68, 30, 59, 31], [6, 31, 89, 19, 23, 75, 55, 76, 51, 47, 53, 41, 72, 39, 37], [44, 83, 6, 2, 64, 17, 35, 58, 62, 50, 18, 48, 30, 31, 45], [14, 64, 5, 31, 3, 0, 85, 88, 50, 45, 47, 76, 41, 58, 79], [54, 31, 51, 68, 78, 59, 50, 1, 24, 65, 84, 22, 32, 9, 49], [9, 17, 89, 78, 53, 81, 59, 5, 65, 14, 37, 77, 55, 42, 32], [55, 27, 14, 50, 44, 1, 35, 31, 20, 37, 28, 8, 87, 15, 12], [70, 0, 37, 28, 52, 30, 24, 46, 57, 69, 77, 6, 18, 86, 12], [21, 28, 35, 53, 69, 24, 72, 23, 79, 36, 40, 14, 75, 56, 17], [79, 37, 51, 34, 49, 55, 76, 72, 69, 38, 40, 19, 8, 23, 47], [28, 33, 51, 86, 30, 64, 23, 41, 24, 62, 61, 84, 7, 35, 44], [68, 57, 24, 19, 30, 9, 6, 77, 17, 8, 21, 61, 82, 86, 79], [2, 8, 43, 21, 86, 3, 78, 10, 59, 27, 73, 74, 46, 16, 63], [62, 74, 16, 49, 36, 88, 82, 67, 13, 37, 41, 34, 8, 52, 30], [2, 86, 30, 48, 46, 54, 61, 64, 77, 80, 68, 31, 78, 14, 11], [74, 20, 42, 87, 35, 9, 48, 70, 24, 61, 50, 49, 82, 31, 40], [84, 42, 85, 12, 3, 68, 11, 40, 8, 53, 71, 16, 15, 39, 73], [15, 64, 71, 10, 82, 65, 36, 48, 88, 17, 1, 54, 79, 45, 8], [61, 48, 44, 45, 52, 50, 70, 39, 4, 53, 66, 18, 86, 69, 29], [54, 80, 48, 46, 84, 51, 43, 7, 81, 79, 23, 27, 70, 69, 21], [56, 60, 5, 63, 85, 74, 88, 44, 11, 33, 69, 62, 47, 81, 25], [71, 21, 77, 56, 81, 15, 40, 51, 50, 60, 46, 41, 24, 32, 52], [19, 9, 39, 40, 2, 14, 85, 49, 89, 34, 44, 0, 8, 74, 5], [53, 87, 64, 82, 9, 0, 60, 50, 73, 49, 56, 6, 78, 35, 85], [52, 0, 38, 22, 45, 82, 1, 77, 66, 40, 46, 23, 56, 89, 36], [68, 15, 7, 56, 87, 59, 85, 27, 3, 35, 11, 58, 79, 60, 14], [34, 51, 72, 78, 87, 29, 4, 83, 55, 19, 15, 66, 76, 48, 82], [65, 61, 12, 2, 89, 40, 45, 4, 86, 80, 60, 35, 22, 62, 84], [50, 75, 44, 67, 89, 80, 70, 88, 78, 1, 66, 0, 57, 86, 49], [61, 3, 83, 41, 84, 42, 0, 15, 54, 82, 35, 64, 73, 20, 72], [25, 0, 54, 17, 29, 10, 36, 60, 14, 39, 84, 1, 11, 42, 23], [67, 84, 73, 71, 57, 55, 28, 88, 17, 62, 89, 43, 47, 44, 23], [7, 52, 42, 8, 36, 30, 12, 2, 19, 44, 70, 47, 25, 71, 38], [41, 77, 18, 46, 81, 17, 67, 29, 19, 62, 1, 16, 56, 88, 87], [5, 87, 54, 61, 29, 35, 20, 71, 4, 30, 55, 72, 58, 16, 52], [42, 28, 87, 56, 29, 57, 5, 12, 37, 78, 51, 77, 39, 71, 38], [9, 73, 68, 88, 76, 16, 74, 70, 24, 12, 20, 3, 39, 38, 62], [15, 69, 33, 7, 32, 22, 5, 21, 81, 44, 29, 13, 70, 39, 53], [81, 45, 47, 36, 66, 49, 71, 88, 58, 53, 89, 84, 7, 74, 62], [34, 64, 82, 24, 38, 89, 66, 15, 39, 56, 75, 72, 74, 31, 88], [67, 83, 57, 29, 69, 78, 45, 20, 21, 32, 5, 62, 22, 80, 56], [67, 73, 63, 78, 4, 9, 3, 33, 54, 30, 26, 52, 43, 27, 62], [49, 17, 29, 81, 38, 28, 69, 26, 13, 74, 58, 44, 68, 16, 46], [62, 42, 43, 5, 75, 13, 50, 69, 64, 16, 27, 36, 45, 18, 84], [66, 40, 1, 20, 81, 72, 8, 89, 70, 44, 30, 57, 74, 88, 73], [76, 43, 67, 18, 71, 84, 8, 25, 73, 5, 70, 82, 9, 34, 10], [22, 28, 18, 30, 70, 63, 26, 33, 76, 64, 8, 62, 55, 9, 72], [16, 66, 72, 36, 33, 55, 25, 22, 39, 84, 26, 75, 80, 4, 20], [4, 30, 83, 17, 81, 0, 71, 22, 78, 75, 55, 21, 80, 13, 18], [17, 36, 40, 4, 10, 28, 18, 71, 46, 45, 69, 81, 22, 75, 57], [4, 39, 13, 68, 22, 83, 57, 5, 72, 33, 45, 52, 21, 26, 81], [46, 72, 76, 13, 18, 36, 63, 83, 68, 22, 45, 10, 26, 40, 25], [55, 67, 25, 83, 4, 80, 72, 18, 7, 26, 57, 45, 63, 46, 78], [33, 68, 4, 26, 27, 0, 78, 28, 46, 7, 10, 83, 63, 80, 25], [81, 3, 14, 35, 40, 4, 34, 86, 67, 44, 29, 77, 12, 10, 28], [32, 59, 35, 81, 11, 61, 77, 10, 1, 44, 33, 68, 3, 80, 88]]};
        
        const SIMBOLI = DATI_CARTELLE.simboli;
        const CARTELLE_PREDEFINITE = DATI_CARTELLE.cartelle;

        // Variabili modalit√†
        let isOnlineMode = false;
        let currentRoom = null;
        let isHost = false;

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyBhmacedonia6z3kNrKtLZkaOcHfiD2XbmJE9r4",
            authDomain: "tombola-romana.firebaseapp.com",
            databaseURL: "https://tombola-romana-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "tombola-romana",
            storageBucket: "tombola-romana.firebasestorage.app",
            messagingSenderId: "970863494827",
            appId: "1:970863494827:web:a8e3f42e5c8a40489ac4fb"
        };

        // Inizializza Firebase
        let firebaseApp = null;
        let database = null;

        try {
            firebaseApp = firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            console.log('‚úÖ Firebase inizializzato');
        } catch (error) {
            console.error('‚ùå Errore Firebase:', error);
        }

        let giocoCorrente = {
            estratti: [],
            inCorso: false,
            premiVinti: {
                ambo: null,
                terno: null,
                quaterna: null,
                cinquina: null,
                tombola: null
            },
            giocatori: [] // [{nome: "Mario", cartella: 23}, ...]
        };

        // Funzione toggle modalit√†
        function switchMode(mode) {
            isOnlineMode = (mode === 'online');
            
            // Aggiorna pulsanti
            document.getElementById('btnModeLocal').style.border = (mode === 'local') ? '3px solid #228B22' : '3px solid #ddd';
            document.getElementById('btnModeLocal').style.background = (mode === 'local') ? 'linear-gradient(135deg, #228B22 0%, #32CD32 100%)' : '#f5f5f5';
            document.getElementById('btnModeLocal').style.color = (mode === 'local') ? 'white' : '#666';
            
            document.getElementById('btnModeOnline').style.border = (mode === 'online') ? '3px solid #4A90E2' : '3px solid #ddd';
            document.getElementById('btnModeOnline').style.background = (mode === 'online') ? 'linear-gradient(135deg, #4A90E2 0%, #357ABD 100%)' : '#f5f5f5';
            document.getElementById('btnModeOnline').style.color = (mode === 'online') ? 'white' : '#666';
            
            // Mostra/nascondi pannelli
            document.getElementById('localPanel').style.display = (mode === 'local') ? 'block' : 'none';
            document.getElementById('onlinePanel').style.display = (mode === 'online') ? 'block' : 'none';
        }

        // Genera codice stanza casuale
        function generateRoomCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        // Crea stanza online
        function createRoom() {
            if (!database) {
                alert('‚ö†Ô∏è Firebase non disponibile!');
                return;
            }

            const roomCode = generateRoomCode();
            currentRoom = roomCode;
            isHost = true;

            // Crea nodo su Firebase
            const roomRef = database.ref('rooms/' + roomCode);
            roomRef.set({
                host: 'Banco',
                createdAt: Date.now(),
                players: {},
                extracted: [],
                gameState: {
                    inCorso: false,
                    premiVinti: {
                        ambo: null,
                        terno: null,
                        quaterna: null,
                        cinquina: null,
                        tombola: null
                    }
                }
            });

            console.log('üéÆ Stanza creata:', roomCode);
            
            // Aggiorna interfaccia
            document.getElementById('onlinePre').style.display = 'none';
            document.getElementById('onlinePost').style.display = 'block';
            document.getElementById('displayRoomCode').textContent = roomCode;
            
            // Listener giocatori
            roomRef.child('players').on('value', snap => {
                const players = snap.val() || {};
                const count = Object.keys(players).length;
                document.getElementById('playersOnlineCount').textContent = 'üë• Giocatori connessi: ' + count;
                console.log('üë• Giocatori:', count);
                
                // Mostra cartelle se il gioco √® iniziato
                if (giocoCorrente.inCorso) {
                    mostraCartelleOnline(players);
                }
            });
        }

        // Mostra cartelle giocatori online
        function mostraCartelleOnline(players) {
            const container = document.getElementById('cartelleGrid');
            container.innerHTML = '';

            Object.entries(players).forEach(([playerId, player]) => {
                const numeroCartella = player.cartella;
                const simboliCartella = CARTELLE_PREDEFINITE[numeroCartella - 1];

                const cartellaDiv = document.createElement('div');
                cartellaDiv.className = 'cartella';
                cartellaDiv.innerHTML = `
                    <div class="cartella-header">${player.name} - Cartella ${numeroCartella}</div>
                    <div class="cartella-grid-cella" id="cartella-${playerId}"></div>
                `;
                container.appendChild(cartellaDiv);

                const grid = document.getElementById(`cartella-${playerId}`);
                simboliCartella.forEach(simboloIndex => {
                    const simbolo = SIMBOLI[simboloIndex];
                    const cella = document.createElement('div');
                    cella.className = 'cartella-cella';
                    cella.dataset.simbolo = simboloIndex;
                    cella.dataset.player = playerId;
                    cella.innerHTML = `
                        <div class="cartella-cella-icona">${simbolo.icona}</div>
                        <div class="cartella-cella-nome">${simbolo.nome}</div>
                    `;
                    
                    if (giocoCorrente.estratti.includes(simboloIndex)) {
                        cella.classList.add('segnato');
                    }
                    
                    grid.appendChild(cella);
                });
            });
        }

        // Popola il select delle cartelle
        function popolaSelectCartelle() {
            const select = document.getElementById('numeroCartella');
            for (let i = 1; i <= 90; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `Cartella ${i}`;
                select.appendChild(option);
            }
        }

        function aggiungiGiocatore() {
            const nome = document.getElementById('nomeGiocatore').value.trim();
            const numeroCartella = parseInt(document.getElementById('numeroCartella').value);

            if (!nome) {
                alert('‚ö†Ô∏è Inserisci il nome del giocatore!');
                return;
            }

            if (!numeroCartella) {
                alert('‚ö†Ô∏è Seleziona il numero della cartella!');
                return;
            }

            // Controlla se la cartella √® gi√† assegnata
            if (giocoCorrente.giocatori.some(g => g.cartella === numeroCartella)) {
                alert(`‚ö†Ô∏è La cartella ${numeroCartella} √® gi√† assegnata!`);
                return;
            }

            // Aggiungi giocatore
            giocoCorrente.giocatori.push({
                nome: nome,
                cartella: numeroCartella
            });

            // Reset form
            document.getElementById('nomeGiocatore').value = '';
            document.getElementById('numeroCartella').value = '';

            aggiornaListaGiocatori();
            aggiornaStats();
        }

        function rimuoviGiocatore(index) {
            if (confirm(`Rimuovere ${giocoCorrente.giocatori[index].nome}?`)) {
                giocoCorrente.giocatori.splice(index, 1);
                aggiornaListaGiocatori();
                aggiornaStats();
                
                if (giocoCorrente.inCorso) {
                    mostraCartelleInGioco();
                }
            }
        }

        function aggiornaListaGiocatori() {
            const container = document.getElementById('listaGiocatori');
            
            if (giocoCorrente.giocatori.length === 0) {
                container.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; color: #999; padding: 20px;">
                        Nessun giocatore registrato. Aggiungi i giocatori prima di iniziare.
                    </div>
                `;
                return;
            }

            container.innerHTML = '';
            giocoCorrente.giocatori.forEach((giocatore, index) => {
                const card = document.createElement('div');
                card.className = 'giocatore-card';
                card.innerHTML = `
                    <button class="btn-remove" onclick="rimuoviGiocatore(${index})">‚úï</button>
                    <div class="giocatore-nome">${giocatore.nome}</div>
                    <div class="giocatore-cartella">Cartella ${giocatore.cartella}</div>
                `;
                container.appendChild(card);
            });
        }

        function inizializzaTabellone() {
            const tabellone = document.getElementById('tabellone');
            tabellone.innerHTML = '';
            
            SIMBOLI.forEach((simbolo, index) => {
                const div = document.createElement('div');
                div.className = 'simbolo';
                div.id = `simbolo-${index}`;
                div.innerHTML = `
                    <div class="simbolo-numero">${index + 1}</div>
                    <div class="simbolo-icona">${simbolo.icona}</div>
                    <div class="simbolo-nome">${simbolo.nome}</div>
                `;
                tabellone.appendChild(div);
            });
        }

        function iniziaGioco() {
            // In modalit√† Online NON serve registrare giocatori localmente
            if (!isOnlineMode && giocoCorrente.giocatori.length === 0) {
                alert('‚ö†Ô∏è Devi prima registrare almeno un giocatore!');
                return;
            }

            // Attiva/disattiva curiosit√†
            curiositaAttive = document.getElementById('toggleCuriosita').checked;
            if (curiositaAttive) {
                console.log('üèõÔ∏è Curiosit√† Trebula ATTIVE');
            }

            giocoCorrente.estratti = [];
            giocoCorrente.inCorso = true;
            giocoCorrente.premiVinti = {
                ambo: null,
                terno: null,
                quaterna: null,
                cinquina: null,
                tombola: null
            };
            
            // Reset Firebase se online
            if (isOnlineMode && currentRoom) {
                database.ref('rooms/' + currentRoom + '/extracted').set([]);
                database.ref('rooms/' + currentRoom + '/gameState').set({
                    inCorso: true,
                    premiVinti: {
                        ambo: null,
                        terno: null,
                        quaterna: null,
                        cinquina: null,
                        tombola: null
                    }
                });
                console.log('üîÑ Firebase inizializzato per nuova partita');
            }
            
            document.getElementById('btnEstrai').disabled = false;
            document.getElementById('currentExtraction').innerHTML = 'Pronto per estrarre!';
            document.getElementById('extractionHistory').innerHTML = '';
            
            // Reset tabellone
            document.querySelectorAll('.simbolo').forEach(el => {
                el.classList.remove('estratto');
            });
            
            // Mostra cartelle
            if (isOnlineMode && currentRoom) {
                // Carica cartelle da Firebase
                database.ref('rooms/' + currentRoom + '/players').once('value').then(snap => {
                    const players = snap.val() || {};
                    mostraCartelleOnline(players);
                });
            } else {
                mostraCartelleInGioco();
            }
            
            aggiornaStats();
        }

        function mostraCartelleInGioco() {
            const container = document.getElementById('cartelleGrid');
            container.innerHTML = '';

            giocoCorrente.giocatori.forEach((giocatore, indexGiocatore) => {
                const numeroCartella = giocatore.cartella;
                const simboliCartella = CARTELLE_PREDEFINITE[numeroCartella - 1];

                const cartellaDiv = document.createElement('div');
                cartellaDiv.className = 'cartella';
                cartellaDiv.innerHTML = `
                    <div class="cartella-header">${giocatore.nome} - Cartella ${numeroCartella}</div>
                    <div class="cartella-grid-cella" id="cartella-${indexGiocatore}"></div>
                `;
                container.appendChild(cartellaDiv);

                const grid = document.getElementById(`cartella-${indexGiocatore}`);
                simboliCartella.forEach(simboloIndex => {
                    const simbolo = SIMBOLI[simboloIndex];
                    const cella = document.createElement('div');
                    cella.className = 'cartella-cella';
                    cella.dataset.simbolo = simboloIndex;
                    cella.dataset.giocatore = indexGiocatore;
                    cella.innerHTML = `
                        <div class="cartella-cella-icona">${simbolo.icona}</div>
                        <div class="cartella-cella-nome">${simbolo.nome}</div>
                    `;
                    
                    if (giocoCorrente.estratti.includes(simboloIndex)) {
                        cella.classList.add('segnato');
                    }
                    
                    grid.appendChild(cella);
                });
            });
        }

        function estraiSimbolo() {
            if (giocoCorrente.estratti.length >= SIMBOLI.length) {
                alert('Tutti i simboli sono stati estratti!');
                return;
            }
            
            let index;
            do {
                index = Math.floor(Math.random() * SIMBOLI.length);
            } while (giocoCorrente.estratti.includes(index));
            
            giocoCorrente.estratti.push(index);
            
            const simbolo = SIMBOLI[index];
            
            document.getElementById('currentExtraction').innerHTML = `
                <div style="font-size: 1.2em; font-weight: bold; color: #8B0000; margin-bottom: 5px;">${index + 1}</div>
                <div style="font-size: 2.5em;">${simbolo.icona}</div>
                <div style="font-size: 0.8em; margin-top: 10px; font-weight: bold;">${simbolo.nome}</div>
            `;
            
            const historyDiv = document.getElementById('extractionHistory');
            const historyItem = document.createElement('div');
            historyItem.className = 'history-item';
            historyItem.innerHTML = `<strong style="color: #8B0000;">${index + 1}</strong> - ${simbolo.icona} ${simbolo.nome}`;
            historyDiv.insertBefore(historyItem, historyDiv.firstChild);
            
            document.getElementById(`simbolo-${index}`).classList.add('estratto');
            
            segnaSuCartelle(index);
            aggiornaStats();
            
            // Pubblica su Firebase se online
            if (isOnlineMode && currentRoom) {
                database.ref('rooms/' + currentRoom + '/extracted').set(giocoCorrente.estratti);
                console.log('üì° Pubblicato su Firebase:', index);
                
                // NON ricaricare tutto! Solo aggiorna i numeri segnati
                // mostraCartelleOnline() viene chiamato solo da iniziaGioco()
            }
            
            // Suono estrazione
            suonoEstrazione();
            
            setTimeout(() => controllaVittorie(), 500);
            
            // Mostra curiosit√† se attive
            setTimeout(() => mostraCuriosita(index), 600);
        }

        function segnaSuCartelle(simboloIndex) {
            document.querySelectorAll('.cartella-cella').forEach(cella => {
                if (parseInt(cella.dataset.simbolo) === simboloIndex) {
                    cella.classList.add('segnato');
                }
            });
        }

        function controllaVittorie() {
            const cartelleDiv = document.querySelectorAll('.cartella');
            
            cartelleDiv.forEach((cartellaDiv, indexGiocatore) => {
                const celle = cartellaDiv.querySelectorAll('.cartella-cella');
                const segnate = cartellaDiv.querySelectorAll('.cartella-cella.segnato');
                const numSegnate = segnate.length;
                
                // Prendi nome e cartella dal DOM (funziona sia locale che online)
                const headerText = cartellaDiv.querySelector('.cartella-header').textContent;
                const match = headerText.match(/(.+) - Cartella (\d+)/);
                const nomeGiocatore = match ? match[1] : 'Giocatore';
                const numeroCartella = match ? match[2] : '?';
                
                // TOMBOLA
                if (numSegnate === 15 && !giocoCorrente.premiVinti.tombola) {
                    giocoCorrente.premiVinti.tombola = {nome: nomeGiocatore, cartella: numeroCartella};
                    
                    // Pubblica TUTTI i premi su Firebase se online (per riepilogo mobile)
                    if (isOnlineMode && currentRoom) {
                        database.ref('rooms/' + currentRoom + '/gameState/premiVinti/tombola').set({
                            nome: nomeGiocatore,
                            cartella: numeroCartella
                        });
                    }
                    
                    mostraVittoriaFinale();
                    return;
                }
                
                // CINQUINA
                if (!giocoCorrente.premiVinti.cinquina && numSegnate >= 5) {
                    if (controllaRigaCompleta(cartellaDiv)) {
                        giocoCorrente.premiVinti.cinquina = {nome: nomeGiocatore, cartella: numeroCartella};
                        
                        // Pubblica su Firebase se online
                        if (isOnlineMode && currentRoom) {
                            database.ref('rooms/' + currentRoom + '/gameState/premiVinti/cinquina').set({
                                nome: nomeGiocatore,
                                cartella: numeroCartella
                            });
                        }
                        
                        mostraVittoria(`üéä CINQUINA! üéä<br>${nomeGiocatore}<br>Cartella ${numeroCartella}`);
                        return;
                    }
                }
                
                // QUATERNA
                if (!giocoCorrente.premiVinti.quaterna && numSegnate >= 4) {
                    if (controllaRiga(cartellaDiv, 4)) {
                        giocoCorrente.premiVinti.quaterna = {nome: nomeGiocatore, cartella: numeroCartella};
                        
                        // Pubblica su Firebase se online
                        if (isOnlineMode && currentRoom) {
                            database.ref('rooms/' + currentRoom + '/gameState/premiVinti/quaterna').set({
                                nome: nomeGiocatore,
                                cartella: numeroCartella
                            });
                        }
                        
                        mostraVittoria(`üéØ QUATERNA! üéØ<br>${nomeGiocatore}<br>Cartella ${numeroCartella}`);
                        return;
                    }
                }
                
                // TERNO
                if (!giocoCorrente.premiVinti.terno && numSegnate >= 3) {
                    if (controllaRiga(cartellaDiv, 3)) {
                        giocoCorrente.premiVinti.terno = {nome: nomeGiocatore, cartella: numeroCartella};
                        
                        // Pubblica su Firebase se online
                        if (isOnlineMode && currentRoom) {
                            database.ref('rooms/' + currentRoom + '/gameState/premiVinti/terno').set({
                                nome: nomeGiocatore,
                                cartella: numeroCartella
                            });
                        }
                        
                        mostraVittoria(`üé™ TERNO! üé™<br>${nomeGiocatore}<br>Cartella ${numeroCartella}`);
                        return;
                    }
                }
                
                // AMBO
                if (!giocoCorrente.premiVinti.ambo && numSegnate >= 2) {
                    if (controllaRiga(cartellaDiv, 2)) {
                        giocoCorrente.premiVinti.ambo = {nome: nomeGiocatore, cartella: numeroCartella};
                        
                        // Pubblica su Firebase se online
                        if (isOnlineMode && currentRoom) {
                            database.ref('rooms/' + currentRoom + '/gameState/premiVinti/ambo').set({
                                nome: nomeGiocatore,
                                cartella: numeroCartella
                            });
                        }
                        
                        mostraVittoria(`üé≤ AMBO! üé≤<br>${nomeGiocatore}<br>Cartella ${numeroCartella}`);
                        return;
                    }
                }
            });
        }

        function controllaRiga(cartellaDiv, numMin) {
            const celle = cartellaDiv.querySelectorAll('.cartella-cella');
            
            for (let riga = 0; riga < 3; riga++) {
                let segnateRiga = 0;
                for (let col = 0; col < 5; col++) {
                    const index = riga * 5 + col;
                    if (celle[index].classList.contains('segnato')) {
                        segnateRiga++;
                    }
                }
                if (segnateRiga >= numMin) {
                    return true;
                }
            }
            return false;
        }

        function controllaRigaCompleta(cartellaDiv) {
            const celle = cartellaDiv.querySelectorAll('.cartella-cella');
            
            for (let riga = 0; riga < 3; riga++) {
                let segnateRiga = 0;
                for (let col = 0; col < 5; col++) {
                    const index = riga * 5 + col;
                    if (celle[index].classList.contains('segnato')) {
                        segnateRiga++;
                    }
                }
                if (segnateRiga === 5) {
                    return true;
                }
            }
            return false;
        }

        function mostraVittoria(messaggio) {
            if (document.querySelector('.vittoria-alert')) return;
            
            // Suono vittoria
            const tipoSuono = messaggio.includes('TOMBOLA') ? 'tombola' : 'premio';
            suonoVittoria(tipoSuono);
            
            document.getElementById('btnEstrai').disabled = true;
            
            const alert = document.createElement('div');
            alert.className = 'vittoria-alert';
            alert.innerHTML = `
                ${messaggio}
                <div style="margin-top: 25px;">
                    <button onclick="confermaVittoria()" style="
                        background: linear-gradient(135deg, #228B22 0%, #32CD32 100%);
                        color: white;
                        border: none;
                        padding: 15px 40px;
                        font-size: 1em;
                        border-radius: 10px;
                        cursor: pointer;
                        font-weight: bold;
                        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                    ">
                        ‚úÖ Continua il Gioco
                    </button>
                </div>
            `;
            document.body.appendChild(alert);
        }

        function confermaVittoria() {
            const alert = document.querySelector('.vittoria-alert');
            if (alert) {
                alert.remove();
            }
            
            if (giocoCorrente.inCorso && giocoCorrente.estratti.length < SIMBOLI.length) {
                document.getElementById('btnEstrai').disabled = false;
            }
        }

        function mostraVittoriaFinale() {
            document.getElementById('btnEstrai').disabled = true;
            giocoCorrente.inCorso = false;
            
            const alert = document.createElement('div');
            alert.className = 'vittoria-alert';
            alert.style.maxWidth = '700px';
            
            let riepilogo = `
                <div style="font-size: 2.5em; margin-bottom: 20px;">
                    üéâ TOMBOLA! üéâ
                </div>
                <div style="font-size: 1.8em; margin-bottom: 10px; color: #FFD700; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">
                    ${giocoCorrente.premiVinti.tombola.nome}
                </div>
                <div style="font-size: 1.2em; margin-bottom: 30px; color: #654321;">
                    Cartella ${giocoCorrente.premiVinti.tombola.cartella}
                </div>
                <div style="font-size: 1em; background: #FFF8DC; padding: 20px; border-radius: 15px; margin-bottom: 25px; border: 3px solid #D2691E;">
                    <div style="font-size: 1.2em; margin-bottom: 15px; color: #8B0000; border-bottom: 2px solid #D2691E; padding-bottom: 10px;">
                        üìã Riepilogo Vincite
                    </div>
            `;
            
            if (giocoCorrente.premiVinti.ambo) {
                riepilogo += `
                    <div style="margin: 10px 0; color: #654321; font-size: 0.9em;">
                        üé≤ <strong>Ambo:</strong> ${giocoCorrente.premiVinti.ambo.nome} (Cartella ${giocoCorrente.premiVinti.ambo.cartella})
                    </div>
                `;
            }
            
            if (giocoCorrente.premiVinti.terno) {
                riepilogo += `
                    <div style="margin: 10px 0; color: #654321; font-size: 0.9em;">
                        üé™ <strong>Terno:</strong> ${giocoCorrente.premiVinti.terno.nome} (Cartella ${giocoCorrente.premiVinti.terno.cartella})
                    </div>
                `;
            }
            
            if (giocoCorrente.premiVinti.quaterna) {
                riepilogo += `
                    <div style="margin: 10px 0; color: #654321; font-size: 0.9em;">
                        üéØ <strong>Quaterna:</strong> ${giocoCorrente.premiVinti.quaterna.nome} (Cartella ${giocoCorrente.premiVinti.quaterna.cartella})
                    </div>
                `;
            }
            
            if (giocoCorrente.premiVinti.cinquina) {
                riepilogo += `
                    <div style="margin: 10px 0; color: #654321; font-size: 0.9em;">
                        üéä <strong>Cinquina:</strong> ${giocoCorrente.premiVinti.cinquina.nome} (Cartella ${giocoCorrente.premiVinti.cinquina.cartella})
                    </div>
                `;
            }
            
            riepilogo += `
                    <div style="margin: 10px 0; color: #654321; font-size: 0.9em;">
                        üéâ <strong>Tombola:</strong> ${giocoCorrente.premiVinti.tombola.nome} (Cartella ${giocoCorrente.premiVinti.tombola.cartella})
                    </div>
                </div>
                <div style="margin-top: 25px;">
                    <button onclick="nuovaPartitaDaVittoria()" style="
                        background: linear-gradient(135deg, #8B0000 0%, #DC143C 100%);
                        color: white;
                        border: none;
                        padding: 15px 40px;
                        font-size: 1em;
                        border-radius: 10px;
                        cursor: pointer;
                        font-weight: bold;
                        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                    ">
                        üé≤ Nuova Partita
                    </button>
                </div>
            `;
            
            alert.innerHTML = riepilogo;
            document.body.appendChild(alert);
        }

        function nuovaPartitaDaVittoria() {
            const alert = document.querySelector('.vittoria-alert');
            if (alert) {
                alert.remove();
            }
            
            // Reset completo senza conferma
            giocoCorrente.estratti = [];
            giocoCorrente.inCorso = false;
            giocoCorrente.premiVinti = {
                ambo: null,
                terno: null,
                quaterna: null,
                cinquina: null,
                tombola: null
            };
            
            // Reset Firebase se online
            if (isOnlineMode && currentRoom) {
                database.ref('rooms/' + currentRoom + '/extracted').set([]);
                database.ref('rooms/' + currentRoom + '/players').set({}); // AZZERA GIOCATORI
                database.ref('rooms/' + currentRoom + '/gameState').set({
                    inCorso: false,
                    premiVinti: {
                        ambo: null,
                        terno: null,
                        quaterna: null,
                        cinquina: null,
                        tombola: null
                    }
                });
                console.log('üîÑ Nuova partita - Firebase resettato');
            }
            
            document.getElementById('btnEstrai').disabled = true;
            document.getElementById('currentExtraction').innerHTML = 
                isOnlineMode ? 'Aspetta che i giocatori si connettano!' : 'Registra i giocatori e premi "Inizia Partita"';
            document.getElementById('extractionHistory').innerHTML = '';
            
            // Reset tabellone
            document.querySelectorAll('.simbolo').forEach(el => {
                el.classList.remove('estratto');
            });
            
            // Reset cartelle
            document.getElementById('cartelleGrid').innerHTML = '';
            
            aggiornaStats();
            
            console.log('‚úÖ Pronto per nuova partita');
        }

        function aggiornaStats() {
            document.getElementById('numGiocatori').textContent = giocoCorrente.giocatori.length;
            document.getElementById('numEstratti').textContent = `${giocoCorrente.estratti.length}/90`;
            document.getElementById('numRimasti').textContent = `${90 - giocoCorrente.estratti.length}`;
        }

        function resetGioco() {
            if (confirm('Vuoi resettare il gioco? (I giocatori registrati verranno mantenuti)')) {
                giocoCorrente.estratti = [];
                giocoCorrente.inCorso = false;
                giocoCorrente.premiVinti = {
                    ambo: null,
                    terno: null,
                    quaterna: null,
                    cinquina: null,
                    tombola: null
                };
                
                // Reset Firebase se online
                if (isOnlineMode && currentRoom) {
                    database.ref('rooms/' + currentRoom + '/extracted').set([]);
                    database.ref('rooms/' + currentRoom + '/players').set({}); // ‚Üê AZZERA GIOCATORI
                    database.ref('rooms/' + currentRoom + '/gameState').set({
                        inCorso: false,
                        premiVinti: {
                            ambo: null,
                            terno: null,
                            quaterna: null,
                            cinquina: null,
                            tombola: null
                        }
                    });
                    console.log('üîÑ Firebase resettato (giocatori rimossi)');
                }
                
                document.getElementById('btnEstrai').disabled = true;
                document.getElementById('currentExtraction').innerHTML = 
                    'Registra i giocatori e premi "Inizia Partita"';
                document.getElementById('extractionHistory').innerHTML = '';
                
                // Reset tabellone
                document.querySelectorAll('.simbolo').forEach(el => {
                    el.classList.remove('estratto');
                });
                
                // Reset cartelle
                document.getElementById('cartelleGrid').innerHTML = '';
                
                // Rimuovi numeri segnati se ci sono cartelle
                document.querySelectorAll('.cartella-cella').forEach(el => {
                    el.classList.remove('segnato');
                });
                
                aggiornaStats();
                
                console.log('‚úÖ Gioco resettato completamente');
            }
        }

        // Inizializza al caricamento
        window.onload = () => {
            inizializzaTabellone();
            popolaSelectCartelle();
            aggiornaStats();
        };
    </script>

    <!-- POPUP CURIOSIT√Ä TREBULA -->
    <div id="popupCuriosita" class="popup-curiosita">
        <div class="popup-curiosita-content">
            <div class="popup-curiosita-header">
                <h2>
                    <span class="popup-curiosita-emoji" id="curiositaEmoji">üèõÔ∏è</span>
                    <span id="curiositaTitolo">Curiosit√† su Trebula Mutuesca</span>
                </h2>
                <span class="close-curiosita" onclick="chiudiCuriosita()">&times;</span>
            </div>
            <div class="popup-curiosita-body">
                <div class="popup-curiosita-simbolo">
                    <div class="popup-curiosita-simbolo-grande" id="curiositaSimbolo">üèõÔ∏è</div>
                    <div class="popup-curiosita-simbolo-info">
                        <span id="curiositaNumero">1</span> - <span id="curiositaNome">Foro</span>
                    </div>
                </div>
                <div class="popup-curiosita-testo" id="curiositaTesto"></div>
            </div>
            <div class="popup-curiosita-footer">
                <button class="btn-continua" onclick="chiudiCuriosita()">
                    ‚ñ∂Ô∏è Continua il Gioco
                </button>
            </div>
        </div>
    </div>

</body>
</html>